<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ordem de Serviço - Manutenção de Box</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0d6efd;
      --success-color: #198754;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --purple-color: #6f42c1;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
    }
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .section-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .section-header {
      background: linear-gradient(135deg, var(--primary-color), #0b5ed7);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .section-header.success { background: linear-gradient(135deg, var(--success-color), #157347); }
    .section-header.warning { background: linear-gradient(135deg, var(--warning-color), #cc9a06); color: #000; }
    .section-header.purple { background: linear-gradient(135deg, var(--purple-color), #5a32a3); }
    .section-body { padding: 20px; }
    .form-label { font-weight: 500; color: #495057; margin-bottom: 5px; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid var(--border-color); padding: 10px 15px; }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    .btn-route { background: linear-gradient(135deg, #17a2b8, #138496); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; }
    .btn-route:hover { background: linear-gradient(135deg, #138496, #117a8b); color: white; }
    .checklist-item { background: var(--light-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); }
    .checklist-item.completed { background: #d1e7dd; border-color: var(--success-color); }
    .checklist-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .checklist-number { background: var(--primary-color); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
    .checklist-item.completed .checklist-number { background: var(--success-color); }
    .photo-upload { border: 2px dashed var(--border-color); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: white; }
    .photo-upload:hover { border-color: var(--primary-color); background: rgba(13, 110, 253, 0.05); }
    .photo-upload i { font-size: 2rem; color: #6c757d; }
    .photo-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; display: none; }
    .signature-pad { border: 2px solid var(--border-color); border-radius: 10px; background: white; width: 100%; height: 150px; }
    .btn-generate { background: linear-gradient(135deg, var(--success-color), #157347); border: none; color: white; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 1.1rem; }
    .btn-generate:hover { background: linear-gradient(135deg, #157347, #146c43); color: white; }
    .star-rating { display: flex; gap: 5px; }
    .star-rating i { font-size: 2rem; color: #dee2e6; cursor: pointer; transition: color 0.2s; }
    .star-rating i:hover, .star-rating i.active { color: var(--warning-color); }
    .divider { height: 3px; background: linear-gradient(90deg, var(--primary-color), var(--success-color)); border-radius: 2px; margin: 30px 0; }
    .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-completed { background: #d1e7dd; color: #0f5132; }
    .form-check-input:checked { background-color: var(--success-color); border-color: var(--success-color); }
    .form-check-label { font-weight: 500; }
    .box-card { background: white; border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .box-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    .box-number-badge { background: var(--primary-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .btn-manutencao { background: linear-gradient(135deg, var(--success-color), #157347); border: none; color: white; }
    .btn-manutencao:hover { background: linear-gradient(135deg, #157347, #146c43); color: white; }
    .btn-pelicula { background: linear-gradient(135deg, var(--purple-color), #5a32a3); border: none; color: white; }
    .btn-pelicula:hover { background: linear-gradient(135deg, #5a32a3, #4a2893); color: white; }
    .modal-header.manutencao { background: linear-gradient(135deg, var(--success-color), #157347); color: white; }
    .modal-header.pelicula { background: linear-gradient(135deg, var(--purple-color), #5a32a3); color: white; }
    .modal-header .btn-close { filter: brightness(0) invert(1); }
    
    /* Serviço selecionável */
    .servico-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 10px; transition: all 0.2s; cursor: pointer; }
    .servico-item:hover { border-color: var(--primary-color); background: rgba(13, 110, 253, 0.03); }
    .servico-item.selected { border-color: var(--success-color); background: #d1e7dd; }
    .servico-item .form-check-input { width: 1.3em; height: 1.3em; margin: 0; cursor: pointer; }
    .servico-item .servico-info { flex: 1; }
    .servico-item .servico-nome { font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .servico-item .servico-valor { font-weight: 700; font-size: 1.1rem; color: var(--success-color); white-space: nowrap; }
    .servico-item .servico-valor.hidden { visibility: hidden; }
    
    /* Orçamento */
    .orcamento-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: 2px solid var(--primary-color); }
    .orcamento-total { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
    .btn-aprovar { background: linear-gradient(135deg, var(--success-color), #157347); border: none; color: white; padding: 15px 40px; border-radius: 12px; font-weight: 700; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3); transition: all 0.3s; }
    .btn-aprovar:hover { background: linear-gradient(135deg, #157347, #146c43); color: white; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4); }
    
    /* Pagamento seção */
    .pagamento-section { display: none; }
    .pagamento-section.show { display: block; }
    
    @media print { .no-print { display: none !important; } .section-card { break-inside: avoid; } }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="h3 fw-bold text-primary"><i class="bi bi-clipboard-check me-2"></i>Ordem de Serviço</h1>
      <p class="text-muted">Manutenção de Box e Colocação de Película</p>
    </div>

    <!-- 1. Dados do Cliente -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-person-fill me-2"></i>1. Dados do Cliente</div>
      <div class="section-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome Completo</label>
            <input type="text" class="form-control" placeholder="Nome do cliente">
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefone</label>
            <input type="tel" class="form-control" placeholder="(00) 00000-0000">
          </div>
          <div class="col-md-6">
            <label class="form-label">E-mail</label>
            <input type="email" class="form-control" placeholder="email@exemplo.com">
          </div>
          <div class="col-md-6">
            <label class="form-label">CEP</label>
            <input type="text" class="form-control" placeholder="00000-000" id="cep">
          </div>
          <div class="col-md-8">
            <label class="form-label">Endereço</label>
            <input type="text" class="form-control" placeholder="Rua, Avenida..." id="endereco">
          </div>
          <div class="col-md-4">
            <label class="form-label">Número</label>
            <input type="text" class="form-control" placeholder="Nº" id="numero">
          </div>
          <div class="col-md-4">
            <label class="form-label">Complemento</label>
            <input type="text" class="form-control" placeholder="Apto, Bloco...">
          </div>
          <div class="col-md-4">
            <label class="form-label">Bairro</label>
            <input type="text" class="form-control" placeholder="Bairro" id="bairro">
          </div>
          <div class="col-md-4">
            <label class="form-label">Cidade/Estado</label>
            <input type="text" class="form-control" placeholder="Cidade - UF" id="cidadeEstado">
          </div>
          <div class="col-12 mt-3">
            <button type="button" class="btn btn-route" onclick="calcularRota()">
              <i class="bi bi-geo-alt-fill me-2"></i>Calcular Rota
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Quantidade de Box -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-grid-3x3-gap-fill me-2"></i>2. Quantidade de Box</div>
      <div class="section-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Quantos boxes serão atendidos?</label>
            <input type="number" class="form-control" id="qtdBox" value="1" min="1" max="10" onchange="renderBoxes()">
          </div>
          <div class="col-md-4">
            <button type="button" class="btn btn-primary" onclick="renderBoxes()">
              <i class="bi bi-arrow-repeat me-2"></i>Atualizar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Boxes Dinâmicos -->
    <div id="boxesContainer"></div>

    <!-- Orçamento Total -->
    <div class="section-card orcamento-card" id="sectionOrcamento">
      <div class="section-header" style="background: linear-gradient(135deg, var(--primary-color), #0b5ed7);">
        <i class="bi bi-receipt me-2"></i>Orçamento
      </div>
      <div class="section-body">
        <div id="resumoServicos" class="mb-4">
          <!-- Itens selecionados aparecem aqui -->
        </div>
        <div class="d-flex justify-content-between align-items-center border-top pt-3">
          <div>
            <span class="text-muted">Valor Total do Orçamento:</span>
            <div class="orcamento-total" id="orcamentoTotal">R$ 0,00</div>
          </div>
          <button type="button" class="btn btn-aprovar" onclick="aprovarOrcamento()">
            <i class="bi bi-check2-circle me-2"></i>Aprovar Orçamento
          </button>
        </div>
      </div>
    </div>

    <!-- Seção de Pagamento (aparece após aprovar) -->
    <div class="section-card pagamento-section" id="sectionPagamento">
      <div class="section-header warning"><i class="bi bi-credit-card me-2"></i>Pagamento</div>
      <div class="section-body">
        <div class="alert alert-success mb-4">
          <i class="bi bi-check-circle-fill me-2"></i>
          <strong>Orçamento aprovado!</strong> Preencha os dados de pagamento abaixo.
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">Valor Total a Pagar</label>
            <input type="text" class="form-control bg-light fs-4 fw-bold text-success" id="valorPagar" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Forma de Pagamento</label>
            <select class="form-select" id="formaPagamento">
              <option value="">Selecione...</option>
              <option value="pix">PIX</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="cartao_credito">Cartão de Crédito</option>
              <option value="cartao_debito">Cartão de Débito</option>
              <option value="transferencia">Transferência Bancária</option>
              <option value="boleto">Boleto</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data do Pagamento</label>
            <input type="date" class="form-control" id="dataPagamento">
          </div>
          <div class="col-12 mt-3">
            <button type="button" class="btn btn-lg btn-success w-100" onclick="confirmarPagamento()">
              <i class="bi bi-check-lg me-2"></i>Confirmar Pagamento
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 4. Data da Solicitação -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-calendar-check me-2"></i>3. Data da Solicitação</div>
      <div class="section-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data da Solicitação</label>
            <input type="datetime-local" class="form-control" id="dataSolicitacao">
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <span class="status-badge status-pending"><i class="bi bi-clock me-1"></i> Preenchimento automático ao salvar</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. Agendamento -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-calendar-event me-2"></i>4. Agendamento</div>
      <div class="section-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data Agendada para o Serviço</label>
            <input type="date" class="form-control" id="dataAgendamento">
          </div>
          <div class="col-md-6">
            <label class="form-label">Horário</label>
            <input type="time" class="form-control" id="horaAgendamento">
          </div>
        </div>
      </div>
    </div>

    <!-- 6. Data do Contato do Prestador -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-telephone-fill me-2"></i>5. Data do Contato do Prestador</div>
      <div class="section-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data que o prestador entrou em contato</label>
            <input type="date" class="form-control" id="dataContato">
          </div>
          <div class="col-md-6">
            <label class="form-label">Nome do Prestador</label>
            <input type="text" class="form-control" placeholder="Nome do prestador">
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefone do Prestador</label>
            <input type="tel" class="form-control" placeholder="(00) 00000-0000">
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Gerar Certificado -->
    <div class="section-card">
      <div class="section-header success"><i class="bi bi-file-earmark-pdf me-2"></i>Gerar Certificado</div>
      <div class="section-body text-center">
        <p class="mb-3">Gere o PDF do Certificado de Manutenção Anual de Box (e Colocação de Película, se realizado) com todas as informações, fotos e garantia de 1 ano.</p>
        <button type="button" class="btn btn-generate" onclick="gerarCertificado()">
          <i class="bi bi-file-earmark-pdf me-2"></i>Gerar PDF e Enviar por E-mail
        </button>
        <p class="text-muted small mt-3"><i class="bi bi-info-circle me-1"></i>O certificado será enviado para o e-mail do cliente e do administrador</p>
      </div>
    </div>

    <!-- Data de Conclusão -->
    <div class="section-card">
      <div class="section-header"><i class="bi bi-calendar-check-fill me-2"></i>Data de Conclusão</div>
      <div class="section-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Data de Conclusão</label>
            <input type="datetime-local" class="form-control" id="dataConclusao" readonly>
            <small class="text-muted">Preenchida automaticamente após envio do certificado</small>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Avaliação do Cliente -->
    <div class="section-card">
      <div class="section-header" style="background: linear-gradient(135deg, #fd7e14, #e55300);">
        <i class="bi bi-star-fill me-2"></i>Avaliação do Cliente
      </div>
      <div class="section-body text-center">
        <p class="mb-3">Como o cliente avalia o serviço prestado?</p>
        <div class="star-rating justify-content-center" id="starRating">
          <i class="bi bi-star-fill" data-rating="1" onclick="setRating(1)"></i>
          <i class="bi bi-star-fill" data-rating="2" onclick="setRating(2)"></i>
          <i class="bi bi-star-fill" data-rating="3" onclick="setRating(3)"></i>
          <i class="bi bi-star-fill" data-rating="4" onclick="setRating(4)"></i>
          <i class="bi bi-star-fill" data-rating="5" onclick="setRating(5)"></i>
        </div>
        <p class="mt-2 text-muted" id="ratingText">Clique nas estrelas para avaliar</p>
        <input type="hidden" id="avaliacao" value="0">
      </div>
    </div>

    <!-- Botões de Ação -->
    <div class="d-flex gap-3 justify-content-center my-4 no-print">
      <button type="button" class="btn btn-lg btn-outline-secondary" onclick="window.print()">
        <i class="bi bi-printer me-2"></i>Imprimir
      </button>
      <button type="button" class="btn btn-lg btn-primary" onclick="salvarOrdem()">
        <i class="bi bi-save me-2"></i>Salvar Ordem
      </button>
    </div>
  </div>

  <!-- Modal Manutenção Anual -->
  <div class="modal fade" id="modalManutencao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header manutencao">
          <h5 class="modal-title"><i class="bi bi-tools me-2"></i>Manutenção Anual - Box <span id="modalManutBoxNum"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalManutBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" onclick="finalizarManutencao()">
            <i class="bi bi-check-circle me-2"></i>Finalizar Manutenção
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Colocação de Película -->
  <div class="modal fade" id="modalPelicula" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header pelicula">
          <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Colocação de Película - Box <span id="modalPeliculaBoxNum"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalPeliculaBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-pelicula" onclick="finalizarPelicula()">
            <i class="bi bi-check-circle me-2"></i>Finalizar Película
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Preços configuráveis
    const PRECO_MANUTENCAO = 250.00;
    const PRECO_PELICULA = 180.00;

    let currentBoxIndex = 0;

    // Formatar moeda
    function formatCurrency(value) {
      return 'R$ ' + value.toFixed(2).replace('.', ',');
    }

    // Gerar HTML de um box
    function createBoxHTML(index) {
      const num = index + 1;
      return `
        <div class="box-card" id="box-${index}">
          <div class="box-card-header">
            <span class="box-number-badge">${num}</span>
            <h5 class="mb-0 fw-bold">Box ${num}</h5>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome do Ambiente</label>
              <input type="text" class="form-control" placeholder="Ex: Banheiro Suíte, Banheiro Social..." id="ambiente-${index}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Foto do Box</label>
              <div class="photo-upload" onclick="document.getElementById('fotoBox-${index}').click()">
                <i class="bi bi-camera"></i>
                <p class="mb-0 small text-muted">Clique para foto</p>
                <input type="file" id="fotoBox-${index}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'previewBox-${index}')">
              </div>
              <img id="previewBox-${index}" class="photo-preview" alt="Preview">
            </div>
            
            <!-- Seleção de Serviços -->
            <div class="col-12">
              <label class="form-label mb-2">Selecione os serviços:</label>
              
              <div class="servico-item" id="servicoManut-${index}" onclick="toggleServico(${index}, 'manut')">
                <input class="form-check-input" type="checkbox" id="checkManut-${index}">
                <div class="servico-info">
                  <div class="servico-nome">
                    <i class="bi bi-tools text-success"></i>
                    Manutenção Anual
                  </div>
                </div>
                <span class="servico-valor hidden" id="valorManut-${index}">${formatCurrency(PRECO_MANUTENCAO)}</span>
                <button type="button" class="btn btn-sm btn-manutencao ms-2" onclick="event.stopPropagation(); abrirModalManutencao(${index})" style="display: none;" id="btnManut-${index}">
                  <i class="bi bi-list-check"></i>
                </button>
              </div>
              
              <div class="servico-item" id="servicoPelicula-${index}" onclick="toggleServico(${index}, 'pelicula')">
                <input class="form-check-input" type="checkbox" id="checkPelicula-${index}">
                <div class="servico-info">
                  <div class="servico-nome">
                    <i class="bi bi-shield-check text-purple" style="color: var(--purple-color);"></i>
                    Troca de Película
                  </div>
                </div>
                <span class="servico-valor hidden" id="valorPelicula-${index}">${formatCurrency(PRECO_PELICULA)}</span>
                <button type="button" class="btn btn-sm btn-pelicula ms-2" onclick="event.stopPropagation(); abrirModalPelicula(${index})" style="display: none;" id="btnPelicula-${index}">
                  <i class="bi bi-list-check"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Toggle serviço
    function toggleServico(boxIndex, tipo) {
      const checkId = tipo === 'manut' ? `checkManut-${boxIndex}` : `checkPelicula-${boxIndex}`;
      const servicoId = tipo === 'manut' ? `servicoManut-${boxIndex}` : `servicoPelicula-${boxIndex}`;
      const valorId = tipo === 'manut' ? `valorManut-${boxIndex}` : `valorPelicula-${boxIndex}`;
      const btnId = tipo === 'manut' ? `btnManut-${boxIndex}` : `btnPelicula-${boxIndex}`;

      const checkbox = document.getElementById(checkId);
      const servico = document.getElementById(servicoId);
      const valor = document.getElementById(valorId);
      const btn = document.getElementById(btnId);

      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        servico.classList.add('selected');
        valor.classList.remove('hidden');
        btn.style.display = 'inline-block';
      } else {
        servico.classList.remove('selected');
        valor.classList.add('hidden');
        btn.style.display = 'none';
      }

      atualizarOrcamento();
    }

    // Atualizar orçamento
    function atualizarOrcamento() {
      const qtd = parseInt(document.getElementById('qtdBox').value) || 1;
      let total = 0;
      let resumoHTML = '';

      for (let i = 0; i < qtd; i++) {
        const ambiente = document.getElementById(`ambiente-${i}`)?.value || `Box ${i + 1}`;
        const checkManut = document.getElementById(`checkManut-${i}`);
        const checkPelicula = document.getElementById(`checkPelicula-${i}`);

        if (checkManut?.checked) {
          total += PRECO_MANUTENCAO;
          resumoHTML += `
            <div class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="bi bi-tools text-success me-2"></i>Manutenção Anual - ${ambiente}</span>
              <span class="fw-bold">${formatCurrency(PRECO_MANUTENCAO)}</span>
            </div>
          `;
        }
        if (checkPelicula?.checked) {
          total += PRECO_PELICULA;
          resumoHTML += `
            <div class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="bi bi-shield-check me-2" style="color: var(--purple-color);"></i>Troca de Película - ${ambiente}</span>
              <span class="fw-bold">${formatCurrency(PRECO_PELICULA)}</span>
            </div>
          `;
        }
      }

      document.getElementById('resumoServicos').innerHTML = resumoHTML || '<p class="text-muted text-center py-3">Nenhum serviço selecionado</p>';
      document.getElementById('orcamentoTotal').textContent = formatCurrency(total);
    }

    // Aprovar orçamento
    function aprovarOrcamento() {
      const total = document.getElementById('orcamentoTotal').textContent;
      if (total === 'R$ 0,00') {
        alert('Selecione pelo menos um serviço para aprovar o orçamento.');
        return;
      }

      document.getElementById('valorPagar').value = total;
      document.getElementById('sectionPagamento').classList.add('show');
      document.getElementById('sectionPagamento').scrollIntoView({ behavior: 'smooth' });
    }

    // Confirmar pagamento
    function confirmarPagamento() {
      const forma = document.getElementById('formaPagamento').value;
      if (!forma) {
        alert('Selecione a forma de pagamento.');
        return;
      }
      alert('Pagamento confirmado com sucesso!\n\nO serviço será agendado em breve.');
    }

    // Renderizar boxes
    function renderBoxes() {
      const qtd = parseInt(document.getElementById('qtdBox').value) || 1;
      const container = document.getElementById('boxesContainer');
      container.innerHTML = '';
      for (let i = 0; i < qtd; i++) {
        container.innerHTML += createBoxHTML(i);
      }
      atualizarOrcamento();
    }

    // Abrir modal de Manutenção Anual
    function abrirModalManutencao(boxIndex) {
      currentBoxIndex = boxIndex;
      document.getElementById('modalManutBoxNum').textContent = boxIndex + 1;
      document.getElementById('modalManutBody').innerHTML = getManutencaoContent(boxIndex);
      new bootstrap.Modal(document.getElementById('modalManutencao')).show();
    }

    // Abrir modal de Película
    function abrirModalPelicula(boxIndex) {
      currentBoxIndex = boxIndex;
      document.getElementById('modalPeliculaBoxNum').textContent = boxIndex + 1;
      document.getElementById('modalPeliculaBody').innerHTML = getPeliculaContent(boxIndex);
      new bootstrap.Modal(document.getElementById('modalPelicula')).show();
    }

    // Conteúdo do checklist de Manutenção Anual
    function getManutencaoContent(boxIndex) {
      return `
        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">1</span>
            <span class="fw-bold">Foto Inicial do Box</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check1-${boxIndex}">
              <label class="form-check-label" for="manut-check1-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('manut-foto1-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto inicial antes da manutenção</p>
            <input type="file" id="manut-foto1-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'manut-preview1-${boxIndex}')">
          </div>
          <img id="manut-preview1-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">2</span>
            <span class="fw-bold">Análise Geral do Box</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check2-${boxIndex}">
              <label class="form-check-label" for="manut-check2-${boxIndex}">Concluído</label>
            </div>
          </div>
          <p class="text-muted small mb-2">Analise o funcionamento e estado geral do box</p>
          <label class="form-label">Análise:</label>
          <textarea class="form-control" rows="4" id="manut-analise-${boxIndex}" placeholder="Descreva em que estado encontrou o box..."></textarea>
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">3</span>
            <span class="fw-bold">Troca das Roldanas</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check3-${boxIndex}">
              <label class="form-check-label" for="manut-check3-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('manut-foto3-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto das roldanas novas</p>
            <input type="file" id="manut-foto3-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'manut-preview3-${boxIndex}')">
          </div>
          <img id="manut-preview3-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">4</span>
            <span class="fw-bold">Análise do Trilho</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check4-${boxIndex}">
              <label class="form-check-label" for="manut-check4-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('manut-foto4-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto do trilho limpo</p>
            <input type="file" id="manut-foto4-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'manut-preview4-${boxIndex}')">
          </div>
          <img id="manut-preview4-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">5</span>
            <span class="fw-bold">Estado Geral do Vidro</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check5-${boxIndex}">
              <label class="form-check-label" for="manut-check5-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="manut-trincas-${boxIndex}">
                <label class="form-check-label text-danger" for="manut-trincas-${boxIndex}">Existem trincas?</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="manut-substituir-${boxIndex}">
                <label class="form-check-label text-warning" for="manut-substituir-${boxIndex}">Necessário substituição?</label>
              </div>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('manut-foto5-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto do estado do vidro</p>
            <input type="file" id="manut-foto5-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'manut-preview5-${boxIndex}')">
          </div>
          <img id="manut-preview5-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);">6</span>
            <span class="fw-bold">Remontagem Final</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="manut-check6-${boxIndex}">
              <label class="form-check-label" for="manut-check6-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('manut-foto6-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto final após manutenção</p>
            <input type="file" id="manut-foto6-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'manut-preview6-${boxIndex}')">
          </div>
          <img id="manut-preview6-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--success-color);"><i class="bi bi-pen"></i></span>
            <span class="fw-bold">Assinatura do Prestador</span>
          </div>
          <canvas id="signatureManut-${boxIndex}" class="signature-pad" width="400" height="150"></canvas>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature('signatureManut-${boxIndex}')">
              <i class="bi bi-eraser me-1"></i> Limpar
            </button>
          </div>
        </div>
      `;
    }

    // Conteúdo do checklist de Película
    function getPeliculaContent(boxIndex) {
      return `
        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">1</span>
            <span class="fw-bold">Foto Geral do Box</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check1-${boxIndex}">
              <label class="form-check-label" for="pel-check1-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('pel-foto1-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Tire uma foto geral do box</p>
            <input type="file" id="pel-foto1-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'pel-preview1-${boxIndex}')">
          </div>
          <img id="pel-preview1-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">2</span>
            <span class="fw-bold">Verificar Condições Gerais do Vidro</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check2-${boxIndex}">
              <label class="form-check-label" for="pel-check2-${boxIndex}">Concluído</label>
            </div>
          </div>
          <p class="text-muted small">Verifique se o vidro está em condições adequadas</p>
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">3</span>
            <span class="fw-bold">Limpeza do Vidro</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check3-${boxIndex}">
              <label class="form-check-label" for="pel-check3-${boxIndex}">Concluído</label>
            </div>
          </div>
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">4</span>
            <span class="fw-bold">Retirar Porta, Roldanas e Puxador</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check4-${boxIndex}">
              <label class="form-check-label" for="pel-check4-${boxIndex}">Concluído</label>
            </div>
          </div>
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">5</span>
            <span class="fw-bold">Aplicar Película na Porta</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check5-${boxIndex}">
              <label class="form-check-label" for="pel-check5-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('pel-foto5-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto da porta com película</p>
            <input type="file" id="pel-foto5-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'pel-preview5-${boxIndex}')">
          </div>
          <img id="pel-preview5-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">6</span>
            <span class="fw-bold">Aplicar Película no Vidro Fixo</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check6-${boxIndex}">
              <label class="form-check-label" for="pel-check6-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('pel-foto6-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto do vidro fixo com película</p>
            <input type="file" id="pel-foto6-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'pel-preview6-${boxIndex}')">
          </div>
          <img id="pel-preview6-${boxIndex}" class="photo-preview" alt="Preview">
        </div>

        <div class="checklist-item">
          <div class="checklist-header">
            <span class="checklist-number" style="background: var(--purple-color);">7</span>
            <span class="fw-bold">Remontagem e Foto Final</span>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="pel-check7-${boxIndex}">
              <label class="form-check-label" for="pel-check7-${boxIndex}">Concluído</label>
            </div>
          </div>
          <div class="photo-upload" onclick="document.getElementById('pel-foto7-${boxIndex}').click()">
            <i class="bi bi-camera"></i>
            <p class="mb-0 mt-2 text-muted">Foto final do box com película</p>
            <input type="file" id="pel-foto7-${boxIndex}" accept="image/*" capture="environment" hidden onchange="previewImage(this, 'pel-preview7-${boxIndex}')">
          </div>
          <img id="pel-preview7-${boxIndex}" class="photo-preview" alt="Preview">
        </div>
      `;
    }

    // Preview de imagens
    function previewImage(input, previewId) {
      const preview = document.getElementById(previewId);
      if (input.files && input.files[0] && preview) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Calcular Rota
    function calcularRota() {
      const endereco = document.getElementById('endereco')?.value.trim() || '';
      const numero = document.getElementById('numero')?.value.trim() || '';
      const bairro = document.getElementById('bairro')?.value.trim() || '';
      const cidadeEstado = document.getElementById('cidadeEstado')?.value.trim() || '';
      const parts = [endereco, numero && `Nº ${numero}`, bairro, cidadeEstado].filter(Boolean);
      const destino = parts.join(', ');
      if (!destino || destino.length < 5) {
        alert('Preencha o endereço do cliente para calcular a rota.');
        return;
      }
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destino)}`, '_blank');
    }

    // Buscar CEP
    document.getElementById('cep').addEventListener('blur', async function() {
      const cep = this.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await response.json();
          if (!data.erro) {
            document.getElementById('endereco').value = data.logradouro || '';
            document.getElementById('bairro').value = data.bairro || '';
            document.getElementById('cidadeEstado').value = `${data.localidade || ''} - ${data.uf || ''}`.trim();
          }
        } catch (e) { console.error('Erro ao buscar CEP:', e); }
      }
    });

    // Avaliação por estrelas
    function setRating(rating) {
      document.getElementById('avaliacao').value = rating;
      const stars = document.querySelectorAll('#starRating i');
      const texts = ['', 'Péssimo', 'Ruim', 'Regular', 'Bom', 'Excelente'];
      stars.forEach((star, index) => {
        star.classList.toggle('active', index < rating);
      });
      document.getElementById('ratingText').textContent = texts[rating];
    }

    // Limpar Assinatura
    function clearSignature(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    // Gerar Certificado
    function gerarCertificado() {
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      document.getElementById('dataConclusao').value = new Date(now - offset).toISOString().slice(0, 16);
      alert('Certificado gerado com sucesso!\n\n(Template) Integre a geração de PDF no seu sistema.');
    }

    // Salvar Ordem
    function salvarOrdem() {
      const inputSolic = document.getElementById('dataSolicitacao');
      if (!inputSolic.value) {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        inputSolic.value = new Date(now - offset).toISOString().slice(0, 16);
      }
      alert('Ordem salva (template local).');
    }

    // Finalizar Manutenção
    function finalizarManutencao() {
      const boxCard = document.getElementById(`box-${currentBoxIndex}`);
      if (boxCard) {
        let badge = boxCard.querySelector('.badge-manut');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'badge bg-success ms-2 badge-manut';
          badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>Manutenção OK';
          boxCard.querySelector('.box-card-header').appendChild(badge);
        }
      }
      bootstrap.Modal.getInstance(document.getElementById('modalManutencao')).hide();
    }

    // Finalizar Película
    function finalizarPelicula() {
      const boxCard = document.getElementById(`box-${currentBoxIndex}`);
      if (boxCard) {
        let badge = boxCard.querySelector('.badge-pelicula');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'badge ms-2 badge-pelicula';
          badge.style.background = 'var(--purple-color)';
          badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>Película OK';
          boxCard.querySelector('.box-card-header').appendChild(badge);
        }
      }
      bootstrap.Modal.getInstance(document.getElementById('modalPelicula')).hide();
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      renderBoxes();
    });
  </script>
</body>
</html>